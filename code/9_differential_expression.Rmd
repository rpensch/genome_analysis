---
title: "R Notebook"
output: html_notebook
---

With: https://informatics.fas.harvard.edu/differential-expression-with-deseq2.html

Set the working directory

```{r setup}
knitr::opts_knit$set(root.dir = 'C:/Users/Raphaela/Documents/UU/GA/genome_analysis/results/8_rna_readcount/')
```

Install DESeq2

```{r message=FALSE, warning=TRUE, include=FALSE}
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("DESeq2")

library("DESeq2")

install.packages("gplots")
library(gplots)

install.packages("RColorBrewer")
library( "RColorBrewer" )
library( "genefilter" )
```

Read in the RNA count files of the different samples and conditions and create a data frame:

```{r}
bh1 <- read.table("htseq_readcount_BH_paired_ERR1797972.txt", row.names = 1, col.names = c('gene', 'ERR1797972'))
bh2 <- read.table("htseq_readcount_BH_paired_ERR1797973.txt", row.names = 1, col.names = c('gene', 'ERR1797973'))
bh3 <- read.table("htseq_readcount_BH_paired_ERR1797974.txt", row.names = 1, col.names = c('gene', 'ERR1797974'))
serum1 <- read.table("htseq_readcount_Serum_paired_ERR1797969.txt", row.names = 1, col.names = c('gene', 'ERR1797969'))
serum2 <- read.table("htseq_readcount_Serum_paired_ERR1797970.txt", row.names = 1, col.names = c('gene', 'ERR1797970'))
serum3 <- read.table("htseq_readcount_Serum_paired_ERR1797971.txt", row.names = 1, col.names = c('gene', 'ERR1797971'))

countData <- data.frame(bh1, bh2, bh3, serum1, serum2, serum3)
```

Create a data frame assigning the samples to the correct conditions:

```{r}
sampleNames <- c('ERR1797972', 'ERR1797973', 'ERR1797974', 'ERR1797969', 'ERR1797970', 'ERR1797971')
condition <- c('BH', 'BH', 'BH', 'Serum', 'Serum', 'Serum')

colData <- data.frame(row.names=colnames(countData), condition=factor(condition, levels=c('BH','Serum')))
```

Create a DESeq2 data set and run the DESeq2 algorithm on it:

```{r warning=TRUE, include=FALSE}
dataset <- DESeqDataSetFromMatrix(countData = countData,
                                  colData = colData,
                                  design = ~condition)
dds <- DESeq(dataset)
```

```{r}
result <- results(dds, contrast=c('condition','Serum','BH'))
significant_result <- result[ which(result$padj < 0.1 ), ]
sum(result$padj > 0.1, na.rm=TRUE)
summary(significant_result)
```

Significant genes with the strongest downregulation:

```{r}
x <- head(significant_result[order(significant_result$log2FoldChange),], n = 20)

write.table(x, "diff_expr_genes_down.txt", sep = " ", dec = ".",
            row.names = TRUE, col.names = TRUE)
x
```

Significant genes with the strongest upregulation:

```{r}
y <- tail(significant_result[order(significant_result$log2FoldChange),], n = 20)

write.table(y, "diff_expr_genes_up.txt", sep = " ", dec = ".",
            row.names = TRUE, col.names = TRUE)

y
```


```{r}
plotMA(result, ylim = c(-1, 1) )
```

```{r}
plotDispEsts(dds, ylim = c(1e-6, 1e1))
```

```{r}
hist( result$pvalue, breaks=20, col="grey")
```

```{r}
rlog_dds <- rlog(dds)
plotPCA(rlog_dds)
```

```{r}
topVarGenes <- head(order(rowVars(assay(rlog_dds)), decreasing=TRUE), 50)
heatmap.2(assay(rlog_dds)[ topVarGenes,], scale="row",trace="none", dendrogram="column",col = colorRampPalette(rev(brewer.pal(9, "RdBu")))(255))
```
